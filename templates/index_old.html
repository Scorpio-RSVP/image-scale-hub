{% extends "base.html" %}

{% block title %}{{ app_name }} - Image Processing Tools{% endblock %}

{% block extra_css %}
<style>
.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.tab {
    padding: 12px 24px;
    border: none;
    background: #e1e5e9;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.tab:hover {
    background: #d1d5db;
}

.tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.tab-content {
    display: none;
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
}

.tab-content.active {
    display: block;
}

/* Upload Area */
.upload-area {
    border: 3px dashed #e1e5e9;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 20px;
}

.upload-area:hover {
    border-color: #667eea;
    background: #f0f4ff;
}

.upload-area.dragover {
    border-color: #667eea;
    background: #e8f0ff;
}

.upload-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.upload-label {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    display: block;
    margin-bottom: 10px;
}

.upload-hint {
    color: #666;
    font-size: 14px;
}

.upload-area input[type="file"] {
    display: none;
}

.selected-file {
    display: none;
    margin-top: 15px;
    padding: 10px 15px;
    background: #d4edda;
    border-radius: 8px;
    color: #155724;
    font-weight: 500;
}

.selected-file.show {
    display: block;
}

/* Live Preview */
.live-preview {
    display: none;
    margin: 20px 0;
    text-align: center;
}

.live-preview.show {
    display: block;
}

.live-preview img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.live-preview-label {
    font-size: 14px;
    color: #666;
    margin-top: 10px;
}

/* Settings */
.settings-container {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.blur-control {
    margin-bottom: 20px;
}

.blur-control:last-child {
    margin-bottom: 0;
}

.blur-control label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.slider {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #e1e5e9;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
}

.slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
}

.slider-value {
    min-width: 60px;
    text-align: center;
    font-weight: 700;
    color: #667eea;
    font-size: 18px;
}

.preset-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.preset-btn {
    padding: 10px 18px;
    border: 2px solid #e1e5e9;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
}

.preset-btn:hover {
    border-color: #667eea;
    background: #f0f4ff;
}

.preset-btn.active {
    border-color: #667eea;
    background: #667eea;
    color: white;
}

.filename-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.filename-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Generate Button */
.generate-btn {
    width: 100%;
    padding: 16px 24px;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.generate-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Preview Section */
.preview-section {
    display: none;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
}

.preview-section.show {
    display: block;
}

.preview-section h3 {
    margin-bottom: 15px;
    color: #333;
}

.preview-image {
    max-width: 100%;
    max-height: 500px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
}

.file-info {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.file-info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e1e5e9;
}

.file-info-row:last-child {
    border-bottom: none;
}

.file-info-label {
    font-weight: 600;
    color: #555;
}

.download-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.download-btn {
    padding: 14px 28px;
    border: none;
    background: #28a745;
    color: white;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.download-btn:hover {
    background: #218838;
    transform: translateY(-2px);
}

/* Resize Methods */
.resize-method {
    margin-top: 15px;
}

/* History */
.history-section h2 {
    margin-bottom: 20px;
    color: #333;
}

.history-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 10px;
}

.history-thumbnail {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
}

.history-info {
    flex: 1;
}

.history-filename {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.history-type {
    font-size: 12px;
    color: #667eea;
    text-transform: uppercase;
    font-weight: 600;
}

.history-date {
    font-size: 12px;
    color: #666;
}

.history-actions {
    display: flex;
    gap: 8px;
}

.history-actions button {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
}

.delete-btn {
    background: #dc3545;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
}

/* Hidden canvas */
#canvas {
    display: none;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .tabs {
        flex-direction: column;
    }
    
    .tab {
        width: 100%;
        text-align: center;
    }
    
    .tab-content {
        padding: 20px;
    }
    
    .upload-area {
        padding: 30px 20px;
    }
    
    .preset-buttons {
        flex-direction: column;
    }
    
    .preset-btn {
        width: 100%;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab active" onclick="showTab('blur')">üñºÔ∏è Blur Tool</button>
        <button class="tab" onclick="showTab('compress')">üì¶ Compress</button>
        <button class="tab" onclick="showTab('resize')">üìè Resize</button>
        <button class="tab" onclick="showTab('history')">üìÅ My Files</button>
    </div>
    
    <!-- BLUR TAB -->
    <div id="blur-tab" class="tab-content active">
        <div class="upload-area" id="blurUploadArea" onclick="document.getElementById('blurFileInput').click()">
            <div class="upload-icon">üì∏</div>
            <label class="upload-label">Click to Upload Image or Drag & Drop</label>
            <p class="upload-hint">Supports: JPG, PNG, GIF, WebP (Max 10MB)</p>
            <input type="file" id="blurFileInput" accept="image/*">
            <div class="selected-file" id="blurSelectedFile">
                ‚úì Image selected: <span id="blurFileName"></span>
            </div>
        </div>
        
        <!-- Live Preview -->
        <div class="live-preview" id="blurLivePreview">
            <img id="blurLivePreviewImg" alt="Preview">
            <p class="live-preview-label">Original Image Preview</p>
        </div>

        <div class="settings-container" id="blurSettings" style="display: none;">
            <div class="blur-control">
                <label>Blur Amount</label>
                <div class="slider-container">
                    <input type="range" id="blurAmount" class="slider" min="0" max="50" value="15">
                    <span class="slider-value" id="blurValue">15px</span>
                </div>
            </div>
            
            <div class="blur-control">
                <label>Blur Style</label>
                <div class="preset-buttons">
                    <button class="preset-btn active" data-preset="frame">Frame Blur</button>
                    <button class="preset-btn" data-preset="full">Full Blur</button>
                    <button class="preset-btn" data-preset="gradient">Gradient Blur</button>
                </div>
            </div>
            
            <div class="blur-control">
                <label>Custom Filename (optional)</label>
                <input type="text" id="blurCustomFilename" class="filename-input" placeholder="blurred-image">
            </div>
        </div>
        
        <button class="generate-btn" id="blurGenerateBtn" disabled onclick="generateBlurImage()">
            ‚ú® Generate Blurred Frame
        </button>
        
        <div class="preview-section" id="blurPreviewSection">
            <h3>üì∏ Preview & Download</h3>
            <img id="blurPreviewImage" class="preview-image" alt="Preview">
            
            <div class="file-info" id="blurFileInfo">
                <div class="file-info-row">
                    <span class="file-info-label">Original Size:</span>
                    <span id="blurOriginalSize">-</span>
                </div>
                <div class="file-info-row">
                    <span class="file-info-label">Dimensions:</span>
                    <span id="blurDimensions">-</span>
                </div>
            </div>
            
            <div class="download-buttons">
                <button class="download-btn" id="blurDownloadBtn">
                    üíæ Download Image
                </button>
            </div>
        </div>
    </div>
    
    <!-- COMPRESS TAB -->
    <div id="compress-tab" class="tab-content">
        <div class="upload-area" id="compressUploadArea" onclick="document.getElementById('compressFileInput').click()">
            <div class="upload-icon">üì¶</div>
            <label class="upload-label">Click to Upload Image for Compression</label>
            <p class="upload-hint">Supports: JPG, PNG, GIF, WebP (Max 10MB)</p>
            <input type="file" id="compressFileInput" accept="image/*">
            <div class="selected-file" id="compressSelectedFile">
                ‚úì Image selected: <span id="compressFileName"></span>
            </div>
        </div>
        
        <!-- Live Preview -->
        <div class="live-preview" id="compressLivePreview">
            <img id="compressLivePreviewImg" alt="Preview">
            <p class="live-preview-label">Original Image Preview</p>
        </div>

        <div class="settings-container" id="compressSettings" style="display: none;">
            <div class="blur-control">
                <label>Quality</label>
                <div class="slider-container">
                    <input type="range" id="compressQuality" class="slider" min="10" max="100" value="80">
                    <span class="slider-value" id="compressQualityValue">80%</span>
                </div>
            </div>
            
            <div class="blur-control">
                <label>Custom Filename (optional)</label>
                <input type="text" id="compressCustomFilename" class="filename-input" placeholder="compressed-image">
            </div>
        </div>
        
        <button class="generate-btn" id="compressBtn" disabled onclick="compressImage()">
            üì¶ Compress Image
        </button>
        
        <div class="preview-section" id="compressPreviewSection">
            <h3>üì∏ Preview & Download</h3>
            <img id="compressPreviewImage" class="preview-image" alt="Preview">
            
            <div class="file-info" id="compressFileInfo">
                <div class="file-info-row">
                    <span class="file-info-label">Original Size:</span>
                    <span id="compressOriginalSize">-</span>
                </div>
                <div class="file-info-row">
                    <span class="file-info-label">Compressed Size:</span>
                    <span id="compressCompressedSize">-</span>
                </div>
                <div class="file-info-row">
                    <span class="file-info-label">Space Saved:</span>
                    <span id="compressSpaceSaved">-</span>
                </div>
            </div>
            
            <div class="download-buttons">
                <button class="download-btn" id="compressDownloadBtn">
                    üíæ Download Compressed Image
                </button>
            </div>
        </div>
    </div>
    
    <!-- RESIZE TAB -->
    <div id="resize-tab" class="tab-content">
        <div class="upload-area" id="resizeUploadArea" onclick="document.getElementById('resizeFileInput').click()">
            <div class="upload-icon">üìè</div>
            <label class="upload-label">Click to Upload Image for Resizing</label>
            <p class="upload-hint">Supports: JPG, PNG, GIF, WebP (Max 10MB)</p>
            <input type="file" id="resizeFileInput" accept="image/*">
            <div class="selected-file" id="resizeSelectedFile">
                ‚úì Image selected: <span id="resizeFileName"></span>
            </div>
        </div>
        
        <!-- Live Preview -->
        <div class="live-preview" id="resizeLivePreview">
            <img id="resizeLivePreviewImg" alt="Preview">
            <p class="live-preview-label">Original Image Preview</p>
        </div>

        <div class="settings-container" id="resizeSettings" style="display: none;">
            <div class="blur-control">
                <label>Resize Method</label>
                <div class="preset-buttons" id="resizeMethodBtns">
                    <button class="preset-btn active" onclick="switchResizeMethod('percentage')">Percentage</button>
                    <button class="preset-btn" onclick="switchResizeMethod('max')">Max Dimension</button>
                    <button class="preset-btn" onclick="switchResizeMethod('specific')">Specific Size</button>
                </div>
            </div>
            
            <!-- Percentage Method -->
            <div id="resize-percentage" class="resize-method">
                <div class="blur-control">
                    <label>Scale Percentage</label>
                    <div class="slider-container">
                        <input type="range" id="resizePercentage" class="slider" min="10" max="200" value="100">
                        <span class="slider-value" id="resizePercentageValue">100%</span>
                    </div>
                </div>
            </div>
            
            <!-- Max Dimension Method -->
            <div id="resize-max" class="resize-method" style="display: none;">
                <div class="blur-control">
                    <label>Maximum Dimension (px)</label>
                    <input type="number" id="resizeMaxDimension" class="filename-input" value="1920" min="10" max="10000">
                </div>
            </div>
            
            <!-- Specific Size Method -->
            <div id="resize-specific" class="resize-method" style="display: none;">
                <div class="blur-control">
                    <label>Width (px)</label>
                    <input type="number" id="resizeWidth" class="filename-input" value="1920" min="10" max="10000">
                </div>
                <div class="blur-control">
                    <label>Height (px)</label>
                    <input type="number" id="resizeHeight" class="filename-input" value="1080" min="10" max="10000">
                </div>
            </div>
            
            <div class="blur-control">
                <label>Custom Filename (optional)</label>
                <input type="text" id="resizeCustomFilename" class="filename-input" placeholder="resized-image">
            </div>
        </div>
        
        <button class="generate-btn" id="resizeBtn" disabled onclick="resizeImage()">
            üìè Resize Image
        </button>
        
        <div class="preview-section" id="resizePreviewSection">
            <h3>üì∏ Preview & Download</h3>
            <img id="resizePreviewImage" class="preview-image" alt="Preview">
            
            <div class="file-info" id="resizeFileInfo">
                <div class="file-info-row">
                    <span class="file-info-label">Original Size:</span>
                    <span id="resizeOriginalSize">-</span>
                </div>
                <div class="file-info-row">
                    <span class="file-info-label">New Dimensions:</span>
                    <span id="resizeNewDimensions">-</span>
                </div>
            </div>
            
            <div class="download-buttons">
                <button class="download-btn" id="resizeDownloadBtn">
                    üíæ Download Resized Image
                </button>
            </div>
        </div>
    </div>
    
    <!-- HISTORY TAB -->
    <div id="history-tab" class="tab-content">
        <div class="history-section">
            <h2>üìÅ My Saved Files</h2>
            <div id="historyContainer">
                <div class="empty-state">
                    <p>No files yet. Generate some blurred or compressed images!</p>
                </div>
            </div>
        </div>
    </div>
    
    <canvas id="canvas"></canvas>
</div>

<script>
// Global variables
let blurSelectedFile = null;
let compressSelectedFile = null;
let resizeSelectedFile = null;

// Tab switching
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
    
    // Load history if needed
    if (tabName === 'history') {
        loadHistory();
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ============ BLUR TOOL ============
function handleBlurFileSelect(file) {
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        alert('‚ö†Ô∏è Please select an image file (JPG, PNG, GIF, WebP)');
        return;
    }
    if (file.size > 10 * 1024 * 1024) {
        alert('‚ö†Ô∏è File size exceeds 10MB limit');
        return;
    }
    blurSelectedFile = file;
    document.getElementById('blurFileName').textContent = file.name;
    document.getElementById('blurSelectedFile').classList.add('show');
    document.getElementById('blurSettings').style.display = 'block';
    document.getElementById('blurGenerateBtn').disabled = false;
    document.getElementById('blurPreviewSection').classList.remove('show');
    
    // Show live preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('blurLivePreviewImg').src = e.target.result;
        document.getElementById('blurLivePreview').classList.add('show');
    };
    reader.readAsDataURL(file);
}

function generateBlurImage() {
    if (!blurSelectedFile) {
        alert('‚ö†Ô∏è Please select an image first!');
        return;
    }
    
    const btn = document.getElementById('blurGenerateBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Processing...';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Apply blur effect
            const blurAmount = document.getElementById('blurAmount').value;
            ctx.filter = `blur(${blurAmount}px)`;
            ctx.drawImage(img, 0, 0);
            
            // Reset filter and draw original on top (frame blur effect)
            ctx.filter = 'none';
            const scale = 0.7;
            const offsetX = (canvas.width - img.width * scale) / 2;
            const offsetY = (canvas.height - img.height * scale) / 2;
            ctx.drawImage(img, offsetX, offsetY, img.width * scale, img.height * scale);
            
            // Show preview
            const dataUrl = canvas.toDataURL('image/png', 0.95);
            document.getElementById('blurPreviewImage').src = dataUrl;
            document.getElementById('blurPreviewSection').classList.add('show');
            
            // Update file info
            document.getElementById('blurOriginalSize').textContent = formatFileSize(blurSelectedFile.size);
            document.getElementById('blurDimensions').textContent = `${img.width} √ó ${img.height}`;
            
            // Set download button
            document.getElementById('blurDownloadBtn').onclick = function() {
                const filename = document.getElementById('blurCustomFilename').value || 'blurred-image';
                const downloadLink = document.createElement('a');
                downloadLink.href = dataUrl;
                downloadLink.download = `${filename}.png`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                saveToHistory(dataUrl, filename + '.png', 'blur');
            };
            
            btn.disabled = false;
            btn.textContent = '‚ú® Generate Blurred Frame';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(blurSelectedFile);
}

// ============ COMPRESS TOOL ============
function handleCompressFileSelect(file) {
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        alert('‚ö†Ô∏è Please select an image file (JPG, PNG, GIF, WebP)');
        return;
    }
    if (file.size > 10 * 1024 * 1024) {
        alert('‚ö†Ô∏è File size exceeds 10MB limit');
        return;
    }
    compressSelectedFile = file;
    document.getElementById('compressFileName').textContent = file.name;
    document.getElementById('compressSelectedFile').classList.add('show');
    document.getElementById('compressSettings').style.display = 'block';
    document.getElementById('compressBtn').disabled = false;
    document.getElementById('compressPreviewSection').classList.remove('show');
    
    // Show live preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('compressLivePreviewImg').src = e.target.result;
        document.getElementById('compressLivePreview').classList.add('show');
    };
    reader.readAsDataURL(file);
}

function compressImage() {
    if (!compressSelectedFile) {
        alert('‚ö†Ô∏è Please select an image first!');
        return;
    }
    
    const btn = document.getElementById('compressBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Compressing...';
    
    const quality = document.getElementById('compressQuality').value / 100;
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            // Compress image
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            
            // Show preview
            document.getElementById('compressPreviewImage').src = compressedDataUrl;
            document.getElementById('compressPreviewSection').classList.add('show');
            
            // Calculate file sizes
            const originalSize = compressSelectedFile.size;
            const compressedSize = Math.round(compressedDataUrl.length * 0.75);
            const spaceSaved = originalSize - compressedSize;
            const percentSaved = Math.round((spaceSaved / originalSize) * 100);
            
            // Update file info
            document.getElementById('compressOriginalSize').textContent = formatFileSize(originalSize);
            document.getElementById('compressCompressedSize').textContent = formatFileSize(compressedSize);
            document.getElementById('compressSpaceSaved').textContent = `${formatFileSize(spaceSaved)} (${percentSaved}%)`;
            
            // Set download button
            document.getElementById('compressDownloadBtn').onclick = function() {
                const filename = document.getElementById('compressCustomFilename').value || 'compressed-image';
                const downloadLink = document.createElement('a');
                downloadLink.href = compressedDataUrl;
                downloadLink.download = `${filename}.jpg`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                saveToHistory(compressedDataUrl, filename + '.jpg', 'compress');
            };
            
            btn.disabled = false;
            btn.textContent = 'üì¶ Compress Image';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(compressSelectedFile);
}

// ============ RESIZE TOOL ============
function handleResizeFileSelect(file) {
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        alert('‚ö†Ô∏è Please select an image file (JPG, PNG, GIF, WebP)');
        return;
    }
    if (file.size > 10 * 1024 * 1024) {
        alert('‚ö†Ô∏è File size exceeds 10MB limit');
        return;
    }
    resizeSelectedFile = file;
    document.getElementById('resizeFileName').textContent = file.name;
    document.getElementById('resizeSelectedFile').classList.add('show');
    document.getElementById('resizeSettings').style.display = 'block';
    document.getElementById('resizeBtn').disabled = false;
    document.getElementById('resizePreviewSection').classList.remove('show');
    
    // Show live preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('resizeLivePreviewImg').src = e.target.result;
        document.getElementById('resizeLivePreview').classList.add('show');
    };
    reader.readAsDataURL(file);
}

function switchResizeMethod(method) {
    // Hide all methods
    document.querySelectorAll('.resize-method').forEach(m => m.style.display = 'none');
    // Remove active from all buttons
    document.querySelectorAll('#resizeMethodBtns .preset-btn').forEach(b => b.classList.remove('active'));
    
    // Show selected method
    document.getElementById('resize-' + method).style.display = 'block';
    // Add active to clicked button
    event.target.classList.add('active');
}

function resizeImage() {
    if (!resizeSelectedFile) {
        alert('‚ö†Ô∏è Please select an image first!');
        return;
    }
    
    const btn = document.getElementById('resizeBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Resizing...';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            let newWidth, newHeight;
            const activeBtn = document.querySelector('#resizeMethodBtns .preset-btn.active');
            const method = activeBtn ? activeBtn.textContent : 'Percentage';
            
            if (method.includes('Percentage')) {
                const scale = document.getElementById('resizePercentage').value / 100;
                newWidth = Math.round(img.width * scale);
                newHeight = Math.round(img.height * scale);
            } else if (method.includes('Max')) {
                const maxDim = parseInt(document.getElementById('resizeMaxDimension').value);
                if (img.width > img.height) {
                    newWidth = maxDim;
                    newHeight = Math.round((img.height / img.width) * maxDim);
                } else {
                    newHeight = maxDim;
                    newWidth = Math.round((img.width / img.height) * maxDim);
                }
            } else {
                newWidth = parseInt(document.getElementById('resizeWidth').value);
                newHeight = parseInt(document.getElementById('resizeHeight').value);
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = newWidth;
            canvas.height = newHeight;
            ctx.drawImage(img, 0, 0, newWidth, newHeight);
            
            // Show preview
            const dataUrl = canvas.toDataURL('image/png', 0.95);
            document.getElementById('resizePreviewImage').src = dataUrl;
            document.getElementById('resizePreviewSection').classList.add('show');
            
            // Update file info
            document.getElementById('resizeOriginalSize').textContent = `${img.width} √ó ${img.height}`;
            document.getElementById('resizeNewDimensions').textContent = `${newWidth} √ó ${newHeight}`;
            
            // Set download button
            document.getElementById('resizeDownloadBtn').onclick = function() {
                const filename = document.getElementById('resizeCustomFilename').value || 'resized-image';
                const downloadLink = document.createElement('a');
                downloadLink.href = dataUrl;
                downloadLink.download = `${filename}.png`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                saveToHistory(dataUrl, filename + '.png', 'resize');
            };
            
            btn.disabled = false;
            btn.textContent = 'üìè Resize Image';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(resizeSelectedFile);
}

// ============ HISTORY ============
function saveToHistory(dataUrl, filename, type) {
    let history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
    history.unshift({
        dataUrl: dataUrl,
        filename: filename,
        type: type,
        timestamp: new Date().toISOString()
    });
    
    // Keep only last 20 items
    if (history.length > 20) {
        history = history.slice(0, 20);
    }
    
    localStorage.setItem('imageHistory', JSON.stringify(history));
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
    const container = document.getElementById('historyContainer');
    
    if (history.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No files yet. Generate some blurred or compressed images!</p></div>';
        return;
    }
    
    container.innerHTML = history.map((item, index) => `
        <div class="history-item">
            <img src="${item.dataUrl}" alt="${item.filename}" class="history-thumbnail">
            <div class="history-info">
                <div class="history-filename">${item.filename}</div>
                <div class="history-type">${item.type}</div>
                <div class="history-date">${new Date(item.timestamp).toLocaleDateString()}</div>
            </div>
            <div class="history-actions">
                <button class="download-btn" onclick="downloadHistoryItem(${index})">üíæ</button>
                <button class="delete-btn" onclick="deleteHistoryItem(${index})">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

function downloadHistoryItem(index) {
    const history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
    const item = history[index];
    if (item) {
        const downloadLink = document.createElement('a');
        downloadLink.href = item.dataUrl;
        downloadLink.download = item.filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
}

function deleteHistoryItem(index) {
    let history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
    history.splice(index, 1);
    localStorage.setItem('imageHistory', JSON.stringify(history));
    loadHistory();
}

// ============ EVENT LISTENERS ============
document.addEventListener('DOMContentLoaded', function() {
    // Blur tool
    const blurFileInput = document.getElementById('blurFileInput');
    blurFileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleBlurFileSelect(e.target.files[0]);
        }
    });
    
    document.getElementById('blurAmount').addEventListener('input', function(e) {
        document.getElementById('blurValue').textContent = e.target.value + 'px';
    });
    
    // Blur preset buttons
    document.querySelectorAll('#blurSettings .preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#blurSettings .preset-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Compress tool
    const compressFileInput = document.getElementById('compressFileInput');
    compressFileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleCompressFileSelect(e.target.files[0]);
        }
    });
    
    document.getElementById('compressQuality').addEventListener('input', function(e) {
        document.getElementById('compressQualityValue').textContent = e.target.value + '%';
    });
    
    // Resize tool
    const resizeFileInput = document.getElementById('resizeFileInput');
    resizeFileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleResizeFileSelect(e.target.files[0]);
        }
    });
    
    document.getElementById('resizePercentage').addEventListener('input', function(e) {
        document.getElementById('resizePercentageValue').textContent = e.target.value + '%';
    });
    
    // Drag and drop for all upload areas
    ['blur', 'compress', 'resize'].forEach(tool => {
        const uploadArea = document.getElementById(tool + 'UploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function() {
            this.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (tool === 'blur') handleBlurFileSelect(files[0]);
                else if (tool === 'compress') handleCompressFileSelect(files[0]);
                else if (tool === 'resize') handleResizeFileSelect(files[0]);
            }
        });
    });
});
</script>
{% endblock %}
